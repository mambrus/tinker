OUTFILENAME    = ../../../lib/lib@PACKAGE_NAME@.a
CC             = @CC@
LD             = @LD@
AR             = @AR@
OBJCOPY        = @OBJCOPY@
OBJDUMP        = @OBJDUMP@
VERSION        = @PACKAGE_VERSION@
CFLAGS         = @CFLAGS@
LDFLAGS        = @LDFLAGS@
LIBS           = @LIBS@
GCC_PATH       = @GCC_PATH@
CANONICAL_HOST = @CANONICAL_HOST@
XCOMPILE       = @XCOMPILE@
ARCH           = @ARCH@
ABI            = @ABI@
TOOLDIR        = @TOOLDIR@
GCC_VERSION    = @GCC_VERSION@
BOARD          = @BOARD@

.PHONY: all info depend link clean rebuild flashit console


ifeq ($(XCOMPILE),1)
   CFLAGS := $(CFLAGS) -DDEBUG -DBOARD=$(BOARD) -DABI=_$(ABI) -DARCH=_$(ARCH) 
   CFLAGS := $(CFLAGS) -mcpu=arm7tdmi -g -gstabs -D RUN_FROM_ROM -D GCC_ARM7 
   CFLAGS := $(CFLAGS) -D CHAINPATH=$(TOOLDIR)/$(CANONICAL_HOST)/include 
   CFLAGS := $(CFLAGS) -I ./ -I ../ -I ../../../include/

   LDFLAGS  := $(LDFLAGS) -Xlinker --relocatable
   
   LDFLAGS := $(LDFLAGS) -nodefaultlibs
   LDFLAGS := $(LDFLAGS) -nostdlib
else
   $(error This package is ONLY supposed to be part of a x-compile)
endif

#-------1---------2---------3---------4---------5---------6---------7---------8
ALL_C :=                   \
   tk_bsp_bitfire.c  		\
   lpc2129_uart_polled.c   \
   lpc2129_vic.c           \
   lpc2129_systimer.c

ALL_COBJS:=$(patsubst %.c, %.o, $(ALL_C))
ALL_CDEPS:=$(patsubst %.c, %.d, $(ALL_C))

ALL_AOBJS:=$(patsubst %.s, %.ao, $(ALL_ASM))


FOUND_CDEPS:= $(shell find . -name "*.d")
#-------1---------2---------3---------4---------5---------6---------7---------8

all: $(ALL_CDEPS) $(ALL_COBJS) $(ALL_AOBJS) $(OUTFILENAME)
	@echo "======================================================"
	@echo "<<- Target [@PACKAGE_NAME@] built! ->>"
	@echo "======================================================"

info: 
	@echo "======================================================"
	@echo [$(OUTFILENAME)] " <cc> " $(CC)
	@echo "======================================================"
	@echo $(FOUND_CDEPS)
	@echo "======================================================"
	@echo "======================================================"
	@echo $(ALL_CDEPS)
	@echo "======================================================"
	@echo "======================================================"
	@echo $(ALL_COBJS)
	@echo "======================================================"


clean: 
	rm -f $(ALL_COBJS) $(ALL_AOBJS) $(ALL_CDEPS) libtinker.a
	@echo "======================================================"
	@echo "<<- Target [@PACKAGE_NAME@] cleaned! ->>"
	@echo "======================================================"


%.d: %.c
	@echo =d2========================================================
	echo $*
	echo $@
	@bash -c 'if [ ! -d ${@D} ]; then echo "-->>>> Creating directory: ${@D}"; mkdir -p ${@D}; fi'
	$(CC) -MM $(CFLAGS) ${@:d=c} > temp
	@sed  -e 's,\(.*\):,$*.o: $@,' > $@ < temp
	@echo

%.o: %.d Makefile-gnu
	@echo =o2========================================================
	$(CC) -c $(CFLAGS) ${@:o=c} -o $@
	@echo

%.ao: %.s Makefile-gnu
	@echo =a2========================================================
	$(CC) -c $(CFLAGS) ${@:ao=s} -o $@
	@echo

$(OUTFILENAME): $(ALL_COBJS) $(ALL_AOBJS) 
	@echo =LINK======================================================
	$(CC) $(CFLAGS) $(LDFLAGS) -DVERSION=\"$(VERSION)\" $(ALL_COBJS) $(ALL_AOBJS) -o $(OUTFILENAME)

ifneq ($(FOUND_CDEPS), )
   include $(FOUND_CDEPS)
endif      
