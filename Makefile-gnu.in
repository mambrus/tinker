CC             = @CC@
LD             = @LD@
AR             = @AR@
OBJCOPY        = @OBJCOPY@
OBJDUMP        = @OBJDUMP@
VERSION        = @VERSION@

#Do not accept default autoconf CFLAGS. Tinker will not run with them (not on ARM tdmi at leat)
#CFLAGS         = @CFLAGS@

GCC_PATH       = @GCC_PATH@
CANONICAL_HOST = @CANONICAL_HOST@
XCOMPILE       = @XCOMPILE@

TOOLDIR = $(subst /bin/@CC@,,$(GCC_PATH))


ifeq ($(XCOMPILE),1)
   BOARD  := BITFIRE
   ABI    := $(shell echo @CANONICAL_HOST@ | sed -e s/.*-//)
   ARCH   := $(shell echo @CANONICAL_HOST@ | sed -e s/-.*//)
   CFLAGS := $(CFLAGS) -DDEBUG -DBOARD=$(BOARD) -DABI=_$(ABI) -DARCH=_$(ARCH) 
   CFLAGS := $(CFLAGS) -mcpu=arm7tdmi -g -gstabs -D RUN_FROM_ROM -D GCC_ARM7 
   CFLAGS := $(CFLAGS) -D CHAINPATH=$(TOOLDIR)/$(CANONICAL_HOST)/include -I include
else
   ABI   :=
   ARCH  := $(shell uname -m | sed -e s/i.86/i386/ -e s/sun4u/sparc64/ -e s/arm.*/arm/ -e s/sa110/arm/)
   CFLAGS := CFLAGS   := $(CFLAGS) -no-integrated-cpp -g3 -O0 -DARCH=_$(ARCH) -DDEBUG -Wall -I include
endif   


#Either one, but not both of the following two
#ALL_LIBS:= kernel/TinKer_$(CPU_T).LIB
#-------1---------2---------3---------4---------5---------6---------7---------8
ALL_TINKERS_C :=                            \
   src/tk.c                          \
   src/tk_itc.c                      \
   src/tk_sysqueues.c                \
   bsp/tk_stubs.c                    \
   bsp/gnu_stubs.c                   \

CFLAGS   := $(CFLAGS)                        \
   -DTK_COMP_ITC=1                           \
   -DTK_COMP_PTIMER=0                        \
   -DTK_COMP_KMEM=0                          \
   -DTK_COMP_PTHREAD=0                       \
   -DTK_COMP_POSIX_RT=0
   
#Start - Not so nice
#-------------------
ifdef XCOMPILE
   ALL_TINKERS_C := $(ALL_TINKERS_C)               			\
      bsp/gnu_arm/tk_angel.c                			         \
      bsp/gnu_arm/tk_systimer.c                             \
      bsp/gnu_arm/lpc21xx/tk_bsp_bitfire.c  			         \
      bsp/gnu_arm/lpc21xx/lpc2129_uart_polled.c             \
      bsp/gnu_arm/lpc21xx/lpc2129_vic.c                     \
      bsp/gnu_arm/lpc21xx/lpc2129_systimer.c
      
#   ALL_ASM       := bsp/gnu_arm/startup_gnu.s
else

endif

#End - Not so nice
#-------------------

ALL_C:= $(ALL_TINKERS_C)   
   
ALL_COBJS:=$(patsubst %.c, %.o, $(ALL_C))
ALL_CDEPS:=$(patsubst %.c, %.d, $(ALL_C))

ALL_AOBJS:=$(patsubst %.s, %.ao, $(ALL_ASM))


FOUND_CDEPS:= $(shell find . -name "*.d")
ifneq ($(FOUND_CDEPS), )
   include $(FOUND_CDEPS)
endif      

#-------1---------2---------3---------4---------5---------6---------7---------8

all: $(ALL_CDEPS) $(ALL_COBJS) $(ALL_AOBJS) libtinker.a
	@echo "======================================================"
	@echo "<<- Target \"all\" for [$(THIS_MODULE)] built! ->>"
	@echo "======================================================"

info: 
	@echo "======================================================"
	@echo $(OUTNAME) " <cc> " $(CC)
	@echo "======================================================"
	@echo $(FOUND_CDEPS)
	@echo "======================================================"
	@echo "======================================================"
	@echo $(ALL_COBJS)
	@echo "======================================================"


clean: 
	rm -f $(ALL_COBJS) $(ALL_AOBJS) $(ALL_CDEPS) libtinker.a
	@echo "======================================================"
	@echo "<<- Target cleaned! ->>"
	@echo "======================================================"

   
%.d: %.c
	@echo =d2========================================================
	echo $*
	echo $@
	@bash -c 'if [ ! -d ${@D} ]; then echo "-->>>> Creating directory: ${@D}"; mkdir -p ${@D}; fi'
	$(CC) -MM $(CFLAGS) ${@:d=c} > temp
	@sed  -e 's,\(.*\):,$*.o: $@,' > $@ < temp
	@echo

%.o: %.d Makefile-gnu Makefile
	@echo =o2========================================================
	$(CC) -c $(CFLAGS) ${@:o=c} -o $@
	@echo
   
%.ao: %.s Makefile-gnu Makefile
	@echo =a2========================================================
	$(CC) -c $(CFLAGS) ${@:ao=s} -o $@
	@echo

libtinker.a: $(ALL_COBJS) $(ALL_AOBJS) 
	$(CC) $(CFLAGS) -Xlinker --relocatable -DVERSION=\"$(VERSION)\" $(ALL_COBJS) $(ALL_AOBJS) -o libtinker.a

